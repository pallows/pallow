<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>모임</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
  </style>
  <link rel="icon"
        href="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FoXBYw%2FbtsIPXrDjTc%2FpLzzFxLchTAtiBSFLAfEX1%2Fimg.png"
        type="image/x-icon">
</head>
<body class="bg-gray-100 p-6">
<div id="meets-container" class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
  <div class="flex items-center mb-6">
    <img id="profile-image" src="https://source.unsplash.com/random/100x100" alt="Profile"
         class="w-24 h-24 rounded-full mr-6">
    <div>
      <h1 id="bigTitle" class="text-2xl font-bold">큰 제목</h1>
      <p id="meets-date" class="text-gray-500">2024.07.20 작성됨</p>
    </div>
    <div class="flex justify-between items-center mb-6">
      <button id="likeButton" class="bg-blue-500 text-white px-4 py-2 rounded ml-4 ">Like <span
          id="likeCount">0</span></button>
      <button id="deleteButton" class="bg-red-500 text-white px-4 py-2 rounded ml-4 ">삭제</button>
    </div>
  </div>
  <div class="grid grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block text-gray-700">참가인원</label>
      <input id="member-count" type="text" class="w-full p-2 border border-gray-300 rounded"
             disabled>
    </div>
    <div>
      <label class="block text-gray-700">위치</label>
      <input id="position" type="text" class="w-full p-2 border border-gray-300 rounded" disabled>
    </div>
    <div>
      <label class="block text-gray-700">제목</label>
      <input id="title" type="text" class="w-full p-2 border border-gray-300 rounded" disabled>
    </div>
    <div>
      <label class="block text-gray-700">모임장</label>
      <input id="groupMaster" type="text" class="w-full p-2 border border-gray-300 rounded"
             disabled>
    </div>
  </div>
  <div class="mb-6">
    <label class="block text-gray-700">모임설명</label>
    <textarea id="content" class="w-full p-2 border border-gray-300 rounded" rows="4" disabled>나의 챌린지 찍는 길 같이 가실 분</textarea>
  </div>
  <div class="flex justify-between items-center mb-6">
    <button id="InvitationList" class="bg-red-500 text-white px-4 py-2 rounded mr-2">참가 신청자 목록
    </button>
    <button id="GroupParticipants" class="bg-green-500 text-white px-4 py-2 rounded">모임 참가자</button>
    <div>
      <button id="participant" class="bg-gray-200 text-gray-700 px-4 py-2 rounded mr-2">참가신청
      </button>
      <button id="closeButton" class="bg-gray-200 text-gray-700 px-4 py-2 rounded">닫기</button>
    </div>
  </div>
  <div class="mb-6">
    <h2 class="text-xl font-bold mb-4">리뷰 작성란</h2>
    <div class="flex items-center mb-4">
      <div class="flex items-center">
        <span class="text-gray-700 mr-2">별점:</span>
        <div id="star-rating" class="flex">
          <svg data-rating="1" class="star w-6 h-6 text-gray-400 cursor-pointer" fill="currentColor"
               viewBox="0 0 20 20">
            <path
                d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.564-.955L10 0l2.948 5.955 6.564.955-4.756 4.635 1.122 6.545z"/>
          </svg>
          <svg data-rating="2" class="star w-6 h-6 text-gray-400 cursor-pointer" fill="currentColor"
               viewBox="0 0 20 20">
            <path
                d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.564-.955L10 0l2.948 5.955 6.564.955-4.756 4.635 1.122 6.545z"/>
          </svg>
          <svg data-rating="3" class="star w-6 h-6 text-gray-400 cursor-pointer" fill="currentColor"
               viewBox="0 0 20 20">
            <path
                d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.564-.955L10 0l2.948 5.955 6.564.955-4.756 4.635 1.122 6.545z"/>
          </svg>
          <svg data-rating="4" class="star w-6 h-6 text-gray-400 cursor-pointer" fill="currentColor"
               viewBox="0 0 20 20">
            <path
                d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.564-.955L10 0l2.948 5.955 6.564.955-4.756 4.635 1.122 6.545z"/>
          </svg>
          <svg data-rating="5" class="star w-6 h-6 text-gray-400 cursor-pointer" fill="currentColor"
               viewBox="0 0 20 20">
            <path
                d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.564-.955L10 0l2.948 5.955 6.564.955-4.756 4.635 1.122 6.545z"/>
          </svg>
        </div>
      </div>
    </div>
    <div class="flex items-center mb-4">
      <textarea id="review-content" class="w-full p-2 border border-gray-300 rounded" rows="2"
                placeholder="리뷰를 작성하세요..."></textarea>
      <button id="submit-review" class="bg-gray-200 text-gray-700 px-4 py-2 rounded ml-4">작성
      </button>
    </div>
  </div>
  <div id="reviews">
  </div>
</div>
<script>
  const accessToken = localStorage.getItem('Authorization');
  const likeButton = document.getElementById('likeButton');
  const likeCountElement = document.getElementById('likeCount');

  function fetchWithAuth(url, options = {}) {
    options.headers = {
      ...options.headers,
      'Authorization': accessToken,
      'Content-Type': 'application/json'
    };
    return fetch(url, options);
  }

  // URL에서 meetId 가져오기
  const path = window.location.pathname;
  const meetId = path.split('/').pop();  // 마지막 경로 부분을 meetId로 추출

  if (!meetId) {
    alert('모임 ID가 필요합니다.');
    window.location.href = '/error-page'; // meetId가 없을 경우 오류 페이지로 리다이렉트
  }

  document.getElementById('closeButton').addEventListener('click', function () {
    if (window.opener) {
      window.opener.location.reload();
    }
    window.close(); // 팝업 창 닫기
  });
  document.getElementById('InvitationList').addEventListener('click', async () => {

    window.open(`/public/InvitationList?meetId=${meetId}`, '신청 목록',
        `width=800,height=600,top=${(screen.height - 600) / 2},left=${(screen.width - 800) / 2}`);
  });

  document.getElementById('participant').addEventListener('click', async function () {
    const userResponse = await fetchWithAuth(`/users/only`)
    const currentUser = await userResponse.json();
    const invitationResponse = await fetchWithAuth(`/groups/${meetId}/invitation`, {
      method: "POST",
      body: JSON.stringify({userId: currentUser.data.id})
    })
    console.log("currentUser.data.id : ", currentUser.data.id)
    if (invitationResponse.ok) {
      alert('해당 모임에 신청을 완료했습니다.');
    } else if (invitationResponse.status === 403) {
      // 403 Forbidden 상태 코드 확인
      const errorResponse = await invitationResponse.json();
      alert(errorResponse.message); // 서버에서 반환한 메시지를 표시
    } else {
      const errorResponse = await invitationResponse.json();
      console.log(errorResponse)
      alert("이미 신청중인 모임입니다.");
    }
  });
  document.addEventListener('DOMContentLoaded', function () {
    if (!accessToken) {
      window.location.href = '/login';
      return;
    }

    let starRating = 0;

    document.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', function () {
        starRating = this.getAttribute('data-rating');
        highlightStars(starRating);
      });
    });

    function handleDeleteReview(event) {
      const reviewId = event.target.getAttribute('data-review-id');
      const confirmDelete = confirm('정말로 이 리뷰를 삭제하시겠습니까?');

      if (confirmDelete) {
        deleteReview(reviewId);
      }
    }

    // 리뷰 삭제 함수
    async function deleteReview(reviewId) {
      try {
        const response = await fetchWithAuth(`/meets/${meetId}/review/${reviewId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('리뷰가 성공적으로 삭제되었습니다.');
          fetchReviews();
        } else if (response.status === 423){
          alert("삭제 권한이 없습니다.")
        } else {
          alert('리뷰 삭제에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error deleting review:', error);
        alert('리뷰 삭제 중 오류가 발생했습니다.');
      }
    }

    async function handleEditReview(event) {
      const reviewId = event.target.getAttribute('data-review-id');
      const reviewElement = event.target.closest('.flex.items-start');
      const reviewContentElement = reviewElement.querySelector('p');
      const starRatingElement = reviewElement.querySelector('.flex.justify-between.items-center div.flex');
      const originalContent = reviewContentElement.textContent;
      const originalStars = starRatingElement.innerHTML;
      reviewContentElement.innerHTML = `
    <textarea id="edit-review-content" class="w-full p-2 border border-gray-300 rounded" rows="2">${reviewContentElement.textContent}</textarea>
  `;
      const currentStarRating = starRatingElement.querySelectorAll('.text-yellow-500').length;
      starRatingElement.innerHTML = `
    ${[...Array(5)].map((_, index) => `
      <svg data-rating="${index + 1}" class="star w-6 h-6 cursor-pointer ${index < currentStarRating ? 'text-yellow-500' : 'text-gray-400'}" fill="currentColor" viewBox="0 0 20 20">
        <path d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.564-.955L10 0l2.948 5.955 6.564.955-4.756 4.635 1.122 6.545z"/>
      </svg>
    `).join('')}
  `;
      let newStarRating = currentStarRating;
      starRatingElement.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function () {
          newStarRating = this.getAttribute('data-rating');
          highlightStars(newStarRating, starRatingElement);
        });
      });
      const submitEditButton = document.createElement('button');
      submitEditButton.classList.add('bg-blue-500', 'text-white', 'px-2', 'py-1', 'rounded', 'mr-2');
      submitEditButton.textContent = '수정 완료';
      submitEditButton.addEventListener('click', async function () {
        const updatedReviewContent = document.getElementById('edit-review-content').value;

        try {
          const response = await fetchWithAuth(`/meets/${meetId}/review/${reviewId}`, {
            method: 'PATCH',
            body: JSON.stringify({ content: updatedReviewContent, starRating: newStarRating })
          });

          if (response.status === 423){
            alert("수정 권한이 없습니다.");
            return;
          }
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          if (data.message === '리뷰를 수정하였습니다.') {
            alert('리뷰가 성공적으로 수정되었습니다.');
            fetchReviews();
          } else {
            throw new Error('리뷰 수정에 실패했습니다.');
          }
        } catch (error) {
          alert('리뷰 수정 중 오류가 발생했습니다.');
        }
      });
      const editButton = reviewElement.querySelector('.edit-review');
      editButton.replaceWith(submitEditButton);
    }

    function highlightStars(rating) {
      document.querySelectorAll('.star').forEach(star => {
        if (star.getAttribute('data-rating') <= rating) {
          star.classList.add('text-yellow-500');
          star.classList.remove('text-gray-400');
        } else {
          star.classList.add('text-gray-400');
          star.classList.remove('text-yellow-500');
        }
      });
    }

    async function fetchMeetDetails() { // meet 하나 조회
      try {
        const response = await fetchWithAuth(`/api/meets/${meetId}`, {
          method: 'GET'
        });
        if (!response.ok) {
          console.log("response: ", response)
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        const resData = data.data;
        displayMeetData(resData);
        await fetchReviews();
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    function displayMeetData(resData) {
      document.getElementById('meets-container').classList.remove('hidden');
      document.getElementById('profile-image').src = resData.image;
      document.getElementById('meets-date').innerText = new Date(
          resData.createdAt).toLocaleDateString();
      document.getElementById(
          'member-count').value = `${resData.memberCount} / ${resData.maxMemberCount}명`;
      document.getElementById('position').value = resData.position || '위치 정보 없음';
      document.getElementById('title').value = resData.title;
      document.getElementById('content').value = resData.content;
      document.getElementById('bigTitle').innerText = resData.title;
      document.getElementById('groupMaster').value = resData.groupCreator;
      console.log("resData.groupCreatorId", resData.groupCreatorId)
      checkIfGroupMaster(resData.groupCreatorId);
    }

    async function checkIfGroupMaster(id) {
      try {
        const userResponse = await fetchWithAuth(`/users/only`);
        const currentUser = await userResponse.json();
        console.log("currentUser.data.id", currentUser.data.id)
        if (currentUser.data.id !== id) {
          document.getElementById('deleteButton').style.display = 'none';
          document.getElementById('InvitationList').style.display = 'none';
        }
        if (currentUser.data.id === id) {
          document.getElementById('deleteButton').style.display = 'block';
          document.getElementById('InvitationList').style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking group master:', error);
      }
    }

    async function fetchReviews() {
      try {
        const response = await fetchWithAuth(`/meets/${meetId}/review`, {
          method: 'GET'
        });
        console.log("meets Reviews : ", response)
        if (!response.ok) {
          throw new Error(`모임에 참여중인 유저가 아닙니다.`);
        }
        const data = await response.json();
        displayReviews(data);
      } catch (error) {
        console.error('Error fetching reviews:', error);
      }
    }

    function displayReviews(data) {
      const reviewsContainer = document.getElementById('reviews');
      reviewsContainer.innerHTML = ''; // 기존 리뷰 초기화

      if (data && data.data && Array.isArray(data.data)) { // data.data가 배열인지 확인
        data.data.forEach(review => {
          const reviewElement = document.createElement('div');
          reviewElement.classList.add('flex', 'items-start', 'mb-4');
          reviewElement.innerHTML = `
        <img src="${review.reviewerProfilePhoto || 'https://source.unsplash.com/random/50x50'}" alt="Reviewer" class="w-12 h-12 rounded-full mr-4">
        <div class="bg-gray-100 p-4 rounded-lg w-full">
          <div class="flex justify-between items-center mb-2">
            <span class="font-bold">${review.reviewerName || 'Anonymous'}</span>
            <div class="flex">
              ${[...Array(review.starRating)].map(() => `
                <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.564-.955L10 0l2.948 5.955 6.564.955-4.756 4.635 1.122 6.545z"/>
                </svg>
              `).join('')}
            </div>
          </div>
          <p>${review.content}</p>
          <div class="flex mt-2">
            <button class="edit-review bg-blue-500 text-white px-2 py-1 rounded mr-2" data-review-id="${review.id}">수정</button>
            <button class="delete-review bg-red-500 text-white px-2 py-1 rounded" data-review-id="${review.id}">삭제</button>
          </div>
        </div>
      `;
          reviewsContainer.appendChild(reviewElement);
        });
        document.querySelectorAll('.edit-review').forEach(button => {
          button.addEventListener('click', handleEditReview);
        });
        document.querySelectorAll('.delete-review').forEach(button => {
          button.addEventListener('click', handleDeleteReview);
        });
      }
    }

    fetchMeetDetails();

    document.getElementById('submit-review').addEventListener('click', async function () {
      const reviewContent = document.getElementById('review-content').value;
      const reviewData = {
        content: reviewContent,
        starRating: starRating
      };

      try {
        const response = await fetchWithAuth(`/meets/${meetId}/review`, {
          method: 'POST',
          body: JSON.stringify(reviewData)
        });
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        if (data.message === '리뷰를 생성하였습니다.') {
          alert('리뷰가 성공적으로 추가되었습니다.');
          document.getElementById('review-content').value = '';
          starRating = 0;
          highlightStars(starRating);
          fetchReviews();
        } else {
          throw new Error('리뷰 작성에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error creating review:', error);
        alert('모임 참가자만 리뷰를 작성할 수 있습니다.');
      }
    });

    document.getElementById('deleteButton').addEventListener('click', async function () {
      const confirmDelete = confirm('정말로 이 모임을 삭제하시겠습니까?');
      if (confirmDelete) {
        const response = await fetchWithAuth(`/api/meets/${meetId}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (data.message === '그룹을 삭제하였습니다.') {
          alert('모임이 성공적으로 삭제되었습니다.');
          if (window.opener) {
            window.opener.location.reload();
          }
          window.close();
        }
      }
    });

    async function initializeLikeStatus() {
      try {
        const response = await fetchWithAuth(`/api/meets/${meetId}`);
        if (response.ok) {
          const data = await response.json();
          console.log("likesCount:", data.data);
          const {likesCount} = data.data;
          likeCountElement.innerText = likesCount;
        }
      } catch (error) {
        console.error('Error fetching like status:', error);
      }
    }

    likeButton.addEventListener('click', async function () {
      const response = await fetchWithAuth(`/api/meets/${meetId}/like`, {
        method: 'POST'
      });
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const updatedResponse = await fetchWithAuth(`/api/meets/${meetId}`);
      if (updatedResponse.ok) {
        const data = await updatedResponse.json();
        const {likesCount} = data.data;
        // 좋아요 수를 업데이트
        likeCountElement.innerText = likesCount;
      }
    });

    document.getElementById('GroupParticipants').addEventListener('click', async () => {
      window.open(`/public/GroupParticipants?meetId=${meetId}`, '모임 참여 인원',
          `width=800,height=600,top=${(screen.height - 600) / 2},left=${(screen.width - 800) / 2}`);
    });

    initializeLikeStatus();
  });
</script>
</body>
</html>