<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Application</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100">
<header class="bg-black text-white p-4">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-2xl" id="chatTitle" th:text="${username} + '\'s Chatting Room'">채팅 목록 / 채팅</h1>
    <div>
      <button class="bg-gray-800 px-4 py-2 rounded">My Page</button>
      <button class="bg-gray-800 px-4 py-2 rounded ml-2">LogOut</button>
    </div>
  </div>
</header>
<main class="container mx-auto mt-4 flex">
  <aside class="w-1/4 bg-gray-800 text-white p-4">
    <ul id="chatRoomsList">
    </ul>
  </aside>
  <section class="w-3/4 bg-white p-4 flex flex-col">
    <div id="chatSection" class="flex-1 overflow-y-auto mb-4">
    </div>
    <div class="flex items-center">
      <input type="text" id="chatInput" class="flex-1 border border-gray-300 p-2 rounded" placeholder="Type a message...">
      <button class="bg-blue-500 text-white px-4 py-2 rounded ml-2" id="sendButton">Send</button>
    </div>
  </section>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let username = localStorage.getItem('username');  // Retrieve stored username
    if (username) {
      document.getElementById('chatTitle').textContent = `${username}'s Chatting Room`;  // Update text
    }

    function fetchChatRooms(username) {
      return fetch(`/chat/getRooms`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(username)
      })
      .then(response => response.json())
      .then(data => {
        return data;
      })
      .catch(error => {
        console.error('Error fetching chat rooms:', error);
      });
    }

    function renderChatRooms(chatRooms) {
      const chatRoomsList = document.getElementById('chatRoomsList');
      chatRoomsList.innerHTML = ''; // Clear any existing chat rooms

      chatRooms.forEach(room => {
        const li = document.createElement('li');
        li.classList.add('mb-2');
        const button = document.createElement('button');
        button.classList.add('w-full', 'text-left');
        button.innerText = room.name;
        button.onclick = () => enterRoom(room.id); // Replace with actual navigation logic
        li.appendChild(button);
        chatRoomsList.appendChild(li);
      });
    }

    function displayChatMessages(roomId) {
      fetchChatMessages(roomId).then(messages => {
        const chatSection = document.getElementById('chatSection');
        chatSection.innerHTML = '';

        messages.forEach(message => {
          const messageDiv = document.createElement('div');
          messageDiv.classList.add('p-2', 'rounded', 'mb-2');
          messageDiv.classList.add(message.sender === username ? 'bg-blue-200' : 'bg-gray-200');
          messageDiv.style.alignSelf = message.sender === username ? 'flex-end' : 'flex-start';

          const messageContent = document.createElement('p');
          messageContent.innerText = message.content;

          const messageTimestamp = document.createElement('span');
          messageTimestamp.classList.add('text-gray-500', 'text-sm');
          messageTimestamp.innerText = new Date(message.createdAt).toLocaleString();

          messageDiv.appendChild(messageContent);
          messageDiv.appendChild(messageTimestamp);
          chatSection.appendChild(messageDiv);
        });
      });
    }

    function fetchChatMessages(roomId) {
      return fetch(`/chat/getMessages`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ roomId })
      })
      .then(response => response.json())
      .then(data => data)
      .catch(error => {
        console.error('Error fetching chat messages:', error);
      });
    }

    function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value;

      if (message && currentRoomId) {
        const chatMessage = {
          content: message,
          sender: username,
          chatRoomId: currentRoomId,
          type: 'CHAT'
        };

        fetch(`/chat/sendMessage`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(chatMessage)
        })
        .then(response => response.json())
        .then(data => {
          chatInput.value = '';
          displayChatMessages(currentRoomId);
        })
        .catch(error => {
          console.error('Error sending message:', error);
        });
      }
    }

    document.getElementById('sendButton').addEventListener('click', sendMessage);

    fetchChatRooms(username).then(chatRooms => {
      renderChatRooms(chatRooms);
    });
  });
</script>

</body>
</html>