<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    .message-bubble {
      max-width: 70%;
      padding: 10px;
      border-radius: 20px;
      margin-bottom: 10px;
    }
    .sender-message {
      background-color: #FFF9C4;
      align-self: flex-start;
    }
    .my-message {
      background-color: #E3F2FD;
      align-self: flex-end;
    }
    .date-divider {
      text-align: center;
      margin: 20px 0;
      color: #888;
    }
  </style>
</head>
<body class="bg-white">
<div class="container mx-auto p-4 flex h-screen">
  <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col">
    <div class="p-4 border-b border-gray-200">
      <h2 class="text-xl font-bold">나의 채팅방</h2>
    </div>
    <ul id="chatRoomList" class="flex-grow overflow-y-auto p-4 space-y-2">
      <!-- 채팅방 목록이 여기에 동적으로 추가됩니다 -->
    </ul>
    <div class="p-4 flex justify-center space-x-4 border-t border-gray-200">
      <button id="createChatRoomBtn" onclick="createChatRoom()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 w-24 h-12 rounded-md transition duration-300 ease-in-out text-sm">
        새 채팅방
      </button>
      <button id="leaveChatRoomBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 w-24 h-12 rounded-md transition duration-300 ease-in-out text-sm">
        채팅방 나가기
      </button>
    </div>
  </div>

  <div class="w-2/3 bg-white flex flex-col">
    <div class="p-4 border-b border-gray-200">
      <h2 id="currentChatRoomName" class="text-xl font-bold">채팅방을 선택해주세요</h2>
    </div>
    <div id="chatMessages" class="flex-grow overflow-y-auto p-4 space-y-2 flex flex-col">
      <!-- 채팅 메시지가 여기에 동적으로 추가됩니다 -->
    </div>
    <div class="p-4">
      <div class="flex rounded-full overflow-hidden bg-gray-100">
        <input id="messageInput" type="text" class="flex-grow p-2 bg-gray-100 focus:outline-none" placeholder="메시지를 입력하세요">
        <button id="sendMessageBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 transition duration-300 ease-in-out">전송</button>
      </div>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  let currentChatRoomId = null;
  const accessToken = localStorage.getItem('Authorization');
  console.log("엑셋슷톡큰", accessToken)

  if (!accessToken) {
    window.location.href = '/login';
  }

  function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({'Authorization': accessToken}, function (frame) {
      console.log('Connected: ' + frame);
      subscribeToNotifications();
      loadChatRooms();
    }, onError);
  }

  function onError(error) {
    console.error('WebSocket Error:', error);
  }

  function subscribeToNotifications() {
    if (stompClient && stompClient.connected) {
      stompClient.subscribe('/user/queue/notifications', onNotificationReceived);
    } else {
      console.error('STOMP client not connected');
    }
  }

  function onNotificationReceived(payload) {
    const notification = JSON.parse(payload.body);
    console.log('Received notification:', notification);
    // 여기에서 알림을 처리합니다. 예를 들어:
    if (notification.type === 'INVITATION') {
      alert(notification.content);
    }
  }

    function isConnected() {
      return stompClient && stompClient.connected;
    }

  function loadChatRooms() {
    fetch('/api/chat/rooms', {
      headers: {
        'Authorization': accessToken
      }
    })
    .then(response => response.json())
    .then(data => {
      const chatRoomList = document.getElementById('chatRoomList');
      chatRoomList.innerHTML = '';
      data.data.forEach(room => {
        const li = document.createElement('li');
        li.textContent = room.name;
        li.className = 'cursor-pointer hover:bg-gray-200 p-2 rounded';
        li.onclick = () => openChatRoom(room.id, room.name);
        chatRoomList.appendChild(li);
      });
    });
  }

  function openChatRoom(roomId, roomName) {
    currentChatRoomId = roomId;
    document.getElementById('currentChatRoomName').textContent = roomName;

    if (stompClient.subscriptions) {
      Object.keys(stompClient.subscriptions).forEach(sub => stompClient.unsubscribe(sub));
    }

    stompClient.subscribe(`/topic/chat/${roomId}`, onMessageReceived);

    loadChatMessages(roomId);
  }

  function loadChatMessages(roomId) {
    fetch(`/api/chat/rooms/${roomId}`, {
      headers: {
        'Authorization': accessToken
      }
    })
    .then(response => response.json())
    .then(data => {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      data.data.messages.forEach(message => {
        appendMessage(message);
      });
    });
  }

  function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    if (message && currentChatRoomId) {
      const chatMessage = {
        chatRoomId: currentChatRoomId,
        content: message
      };
      stompClient.send("/app/chat.sendMessage", {'Authorization': accessToken}, JSON.stringify(chatMessage));
      messageInput.value = '';
    }
  }

  function onMessageReceived(payload) {
    const message = JSON.parse(payload.body);
    appendMessage(message);
  }

  function appendMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = 'mb-2';
    messageElement.innerHTML = `
                <strong>${message.sender}:</strong> ${message.content}
                <small class="text-gray-500">${message.formattedTime}</small>
            `;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function createChatRoom() {
    console.log("asdfasdf");
    const roomName = prompt("새 채팅방 이름을 입력하세요:");
    if (roomName) {
      const invitedUserNickname = prompt("초대할 유저의 닉네임을 입력하세요:");
      if (invitedUserNickname) {
        fetch('/api/chat/rooms', {
          method: 'POST',
          headers: {
            'Authorization': accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: roomName,
            invitedUserNickname: invitedUserNickname
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
          } else {
            alert(`채팅방이 생성되었고, ${invitedUserNickname}님에게 초대 메시지를 보냈습니다.`);
            loadChatRooms();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('채팅방 생성 중 오류가 발생했습니다.');
        });
      } else {
        alert('초대할 유저의 닉네임을 입력해야 합니다.');
      }
    }
  }

  function joinRoom(roomId, isAnonymous = false) {
    if (stompClient) {
      let joinMessage = {
        roomId: roomId,
        isAnonymous: isAnonymous,
        type: 'JOIN'
      };
      stompClient.send("/app/chat.joinRoom", {}, JSON.stringify(joinMessage));
    }
  }

  function appendMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');

    if (message.type === 'JOIN') {
      messageElement.className = 'text-center text-gray-500 my-2';
      messageElement.textContent = `${message.sender}님이 입장하셨습니다.`;
    } else if (message.type === 'LEAVE') {
      messageElement.className = 'text-center text-gray-500 my-2';
      messageElement.textContent = `${message.sender}님이 퇴장하셨습니다.`;
    } else {
      const isMyMessage = message.sender === 'Me'; // 실제 구현에서는 현재 사용자와 비교해야 합니다
      messageElement.className = `message-bubble ${isMyMessage ? 'my-message' : 'sender-message'}`;
      messageElement.innerHTML = `
            <div class="font-bold">${message.sender}</div>
            <div>${message.content}</div>
            <div class="text-xs text-gray-500 text-right">${message.formattedTime}</div>
        `;
    }

    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  stompClient.subscribe('/user/queue/notifications', onNotificationReceived);

  function onNotificationReceived(payload) {
    const notification = JSON.parse(payload.body);
    if (notification.type === 'INVITATION') {
      // 초대 알림을 표시하는 로직
      showInvitationNotification(notification);
    }
  }

  function showInvitationNotification(notification) {
    // 예: 알림 창을 띄우거나 화면에 표시
    alert(notification.content);
    // 또는 더 세련된 UI로 표시할 수 있습니다.
  }

  function leaveRoom() {
    if (stompClient && currentChatRoomId) {
      let leaveMessage = {
        roomId: currentChatRoomId,
        type: 'LEAVE'
      };
      stompClient.send("/app/chat.leaveRoom", {}, JSON.stringify(leaveMessage));

      // 채팅방 삭제 요청
      fetch(`/api/chat/rooms/${currentChatRoomId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': accessToken
        }
      })
      .then(response => {
        if (response.ok) {
          currentChatRoomId = null;
          document.getElementById('currentChatRoomName').textContent = "채팅방을 선택해주세요";
          document.getElementById('chatMessages').innerHTML = '';
          loadChatRooms(); // 채팅방 목록 새로고침
        } else {
          alert('채팅방 나가기 실패');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('채팅방 나가기 중 오류가 발생했습니다.');
      });
    }
  }


  connect();
</script>
</body>
</html>