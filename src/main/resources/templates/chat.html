<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    #chatMessages {
      display: flex;
      flex-direction: column;
    }
    .message-bubble {
      max-width: 70%;
      padding: 10px;
      border-radius: 20px;
      margin-bottom: 10px;
    }
    .sender-message {
      background-color: #FFF9C4;
      align-self: flex-start;
      margin-right: auto;
    }
    .my-message {
      background-color: #E3F2FD;
      align-self: flex-end;
      margin-left: auto;
    }
    .date-divider {
      text-align: center;
      margin: 20px 0;
      color: #888;
    }
  </style>
</head>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<body class="bg-white">
<header class="flex justify-between items-center p-4 bg-white shadow">
  <div class="flex items-center">
    <a href="/public/main">
      <img src="https://github.com/user-attachments/assets/38c43d3b-dce7-422c-b89a-572308799e96" width="70" height="70" alt="Logo" class="mr-4">
    </a>
    <nav>
      <a th:href="@{/public/main}" class="mr-4">홈</a>
      <a href="/public/userboardCollection" class="mr-4">오늘의 동친</a>
      <a href="/public/meetsCollection" class="mr-4">내 주변 모임</a>
      <a href="/public/MyPage" class="mr-4">MyPage</a>
    </nav>
  </div>
  <div class="flex items-center">
    <button id="profileBtn" class="mr-4">내 프로필</button>
    <button id="logoutBtn" class="bg-black text-white px-4 py-2 rounded">로그아웃</button>
  </div>
</header>
<div class="container mx-auto p-4 flex h-screen">
  <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col">
    <div class="p-4 border-b border-gray-200">
      <h2 class="text-xl font-bold">나의 채팅방</h2>
    </div>
    <div id="connectionStatus"></div>
    <ul id="chatRoomList" class="flex-grow overflow-y-auto p-4 space-y-2">
      <!-- 채팅방 목록이 여기에 동적으로 추가됩니다 -->
    </ul>
    <div class="p-4 flex justify-center space-x-4 border-t border-gray-200">
      <button id="createChatRoomBtn" onclick="createChatRoom()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 w-24 h-12 rounded-md transition duration-300 ease-in-out text-sm">
        새 채팅방
      </button>
      <button id="leaveChatRoomBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 w-24 h-12 rounded-md transition duration-300 ease-in-out text-sm">
        채팅방 나가기
      </button>
    </div>
  </div>

  <div class="w-2/3 bg-white flex flex-col">
    <div class="p-4 border-b border-gray-200">
      <h2 id="currentChatRoomName" class="text-xl font-bold">채팅방을 선택해주세요</h2>
    </div>
    <div id="chatMessages" class="flex-grow overflow-y-auto p-4 space-y-2 flex flex-col">
      <!-- 채팅 메시지가 여기에 동적으로 추가됩니다 -->
    </div>
    <div class="p-4">
      <div class="flex rounded-full overflow-hidden bg-gray-100">
        <input id="messageInput" type="text" class="flex-grow p-2 bg-gray-100 focus:outline-none" placeholder="메시지를 입력하세요">
        <button id="sendMessageBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 transition duration-300 ease-in-out">전송</button>
      </div>
    </div>
  </div>
</div>
</body>

<script>

  document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
  document.getElementById('leaveChatRoomBtn').addEventListener('click', leaveRoom);



  let stompClient = null;
  let currentChatRoomId = null;
  let currentUser = null;
  let currentRoomParticipants = [];
  let isConnected = false;
  const accessToken = localStorage.getItem('Authorization');
  console.log("엑셋슷톡큰", accessToken)

  if (!accessToken) {
    window.location.href = '/login';
  }
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded and parsed");
    loadUserInfo()
    .then(() => {
      connect();
      setInterval(checkConnection, 60000);
    })
    .catch(error => {
      console.error('Failed to load user info:', error);
      // 사용자에게 오류 메시지를 표시하거나 로그인 페이지로 리다이렉트
    });
  });

  function loadUserInfo() {
    return fetch('/users/me', {
      headers: {
        'Authorization': accessToken
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.data && data.data.nickname) {
        currentUser = data.data;
        console.log('Current user loaded:', currentUser);
      } else {
        console.error('No user data received or unexpected data format');
      }
    })
    .catch(error => {
      console.error('Error loading user info:', error);
    });
  }

  function connect() {
    if (isConnected) return;
    console.log("Attempting to connect to WebSocket");
    const socket = new SockJS('http://localhost:8080/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({'Authorization': accessToken}, onConnected, onError);
  }

  function onConnected(frame) {
    console.log('Connected: ' + frame);
    isConnected = true;

    // 초기 사용자 정보 로드
    loadUserInfo().then(() => {
      // WebSocket을 통한 실시간 사용자 정보 업데이트 구독
      stompClient.subscribe('/user/queue/info', function(message) {
        try {
          const userInfo = JSON.parse(message.body);
          if (userInfo && userInfo.nickname) {
            currentUser = userInfo;
            console.log('Updated current user info:', currentUser);
          }
        } catch (error) {
          console.error('Error parsing user info:', error);
        }
      });

      stompClient.send("/app/chat.getUserInfo", {}, {});
      stompClient.send("/app/chat.connect");
      console.log("Sent chat.connect message");
      subscribeToNotifications();
      loadChatRooms();
      updateConnectionStatus(true);
    }).catch(error => {
      console.error('Failed to load initial user info:', error);
      // 에러 처리 로직 (예: 재연결 시도 또는 사용자에게 알림)
    });
  }

  function onError(error) {
    console.error('STOMP error:', error);
    isConnected = false;
    updateConnectionStatus(false);
    setTimeout(connect, 5000); // 5초 후 재연결 시도
  }

  function updateConnectionStatus(isConnected) {
    // 연결 상태를 UI에 표시하는 로직
    const statusElement = document.getElementById('connectionStatus');
    if (statusElement) {
      statusElement.textContent = isConnected ? '연결됨' : '연결 끊김';
      statusElement.style.color = isConnected ? 'green' : 'red';
    }
  }



  // 주기적으로 연결 상태를 확인하는 함수
  function checkConnection() {
    if (!stompClient || !stompClient.connected) {
      console.log("Connection lost. Attempting to reconnect...");
      connect();
    }
  }

  // 문서 로드 완료 시 실행
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded and parsed");
    connect();
    setInterval(checkConnection, 60000); // 60초마다 연결 상태 확인
  });



  function loadChatRooms() {
    fetch('/api/chat/rooms', {
      headers: {
        'Authorization': accessToken
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      const chatRoomList = document.getElementById('chatRoomList');
      chatRoomList.innerHTML = '';
      data.data.forEach(room => {
        const li = document.createElement('li');
        li.textContent = room.name;
        li.className = 'cursor-pointer hover:bg-gray-200 p-2 rounded';
        li.onclick = () => openChatRoom(room.id, room.name);
        chatRoomList.appendChild(li);
      });
    })
    .catch(error => {
      console.error('Error loading chat rooms:', error);
      alert('채팅방 목록을 불러오는 데 실패했습니다.');
    });
  }

  let currentSubscription = null;

  function onParticipantsUpdated(payload) {
    const participants = JSON.parse(payload.body);
    console.log('Room participants updated:', participants);
  }

    function openChatRoom(roomId, roomName) {
      currentChatRoomId = roomId;
      document.getElementById('currentChatRoomName').textContent = roomName;

      if (currentSubscription) {
        currentSubscription.unsubscribe();
      }
      currentSubscription = stompClient.subscribe(`/topic/chat/${roomId}`, onMessageReceived);

      loadChatMessages(roomId);
      stompClient.subscribe(`/topic/chat/${roomId}/participants`, onParticipantsUpdated);
      stompClient.send("/app/chat.getRoomParticipants", {}, JSON.stringify({roomId: roomId}));
    }

    function loadChatMessages(roomId) {
      fetch(`/api/chat/rooms/${roomId}`, {
        headers: {
          'Authorization': accessToken
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load chat messages');
        }
        console.log("{}", response);
        return response.json();
      })
      .then(data => {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        if (data.data && Array.isArray(data.data.messages)) {
          data.data.messages.forEach(message => {
            appendMessage(message);
          });
        } else {
          console.error('Unexpected data format:', data);
        }
      })
      .catch(error => {
        console.error('Error loading chat messages:', error);
        alert('채팅 메시지를 불러오는 데 실패했습니다.');
      });
    }

  function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    if (message && currentChatRoomId) {
      console.log('Current user before sending message:', currentUser);
      const chatMessage = {
        chatRoomId: currentChatRoomId,
        content: message
      };
      fetch('/api/chat/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': accessToken
        },
        body: JSON.stringify(chatMessage)
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.error('Error sending message:', data.error);
        } else {
          console.log('Message sent successfully:', data.data);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
      messageInput.value = '';
    }
  }

    function onMessageReceived(payload) {
      const message = JSON.parse(payload.body);
      console.log(`Received message in room ${currentChatRoomId}: `, message);
      appendMessage(message);
    }

    function subscribeToNotifications() {
      console.log("Attempting to subscribe to notifications");
      if (stompClient && stompClient.connected) {
        stompClient.subscribe('/user/queue/notifications', onNotificationReceived,
            {'Authorization': accessToken});
        console.log("Successfully subscribed to notifications");
      } else {
        console.error('STOMP client not connected. Unable to subscribe to notifications');
        // 연결이 완료되면 다시 시도
        setTimeout(subscribeToNotifications, 1000);
      }
    }

    function createChatRoom() {
      console.log("createChatRoom을 실행했습니다.");
      const roomName = prompt("새 채팅방 이름을 입력하세요:");
      if (roomName) {
        const otherUserNickname = prompt("대화할 상대방의 닉네임을 입력하세요:");
        if (otherUserNickname) {
          fetch('/api/chat/rooms', {
            method: 'POST',
            headers: {
              'Authorization': accessToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: roomName,
              otherUserNickname: otherUserNickname
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert(data.error);
            } else {
              alert(`${otherUserNickname}님과의 채팅방이 생성되었습니다.`);
              loadChatRooms();
              // 새로 생성된 채팅방으로 바로 입장
              openChatRoom(data.data.id, data.data.name);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('채팅방 생성 중 오류가 발생했습니다.');
          });
        } else {
          alert('대화할 상대방의 닉네임을 입력해야 합니다.');
        }
      }
    }

    function joinRoom(roomId) {
      if (stompClient) {
        let joinMessage = {
          roomId: roomId,
          type: 'JOIN'
        };
        stompClient.send("/app/chat.joinRoom", {}, JSON.stringify(joinMessage));
      }
    }

    function onNotificationReceived(payload) {
      console.log('Received notification payload:', payload);
      const notification = JSON.parse(payload.body);
      console.log('Parsed notification:', notification);
      // 초대 관련 로직 제거
    }

    function appendMessage(message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');

      if (message.type === 'JOIN' || message.type === 'LEAVE') {
        messageElement.className = 'text-center text-gray-500 my-2';
        messageElement.textContent = `${message.sender}님이 ${message.type === 'JOIN' ? '입장'
            : '퇴장'}하셨습니다.`;
      }else {
        const isMyMessage = currentUser && message.sender === currentUser.nickname;
        console.log('Is my message:', isMyMessage, 'Sender:', message.sender, 'Current user:', currentUser?.nickname);

        messageElement.className = `message-bubble ${isMyMessage ? 'my-message'
            : 'sender-message'}`;

        // 추가 스타일 적용
        if (isMyMessage) {
          messageElement.style.alignSelf = 'flex-end';
          messageElement.style.backgroundColor = '#E3F2FD';
        } else {
          messageElement.style.alignSelf = 'flex-start';
          messageElement.style.backgroundColor = '#FFF9C4';
        }

        messageElement.innerHTML = `
            <div class="font-bold">${message.sender}</div>
            <div>${message.content}</div>
            <div class="text-xs text-gray-500 text-right">${message.formattedTime || new Date().toLocaleTimeString()}</div>
        `;
      }

      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

  function leaveRoom() {
    if (stompClient && currentChatRoomId) {
      let leaveMessage = {
        roomId: currentChatRoomId,
        type: 'LEAVE'
      };
      stompClient.send("/app/chat.leaveRoom", {}, JSON.stringify(leaveMessage));

      // 서버의 응답을 기다린 후 채팅방 삭제 요청
      setTimeout(() => {
        fetch(`/api/chat/rooms/${currentChatRoomId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': accessToken
          }
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('채팅방 나가기 실패');
          }
        })
        .then(data => {
          console.log('채팅방 나가기 성공:', data);
          currentChatRoomId = null;
          document.getElementById('currentChatRoomName').textContent = "채팅방을 선택해주세요";
          document.getElementById('chatMessages').innerHTML = '';
          loadChatRooms(); // 채팅방 목록 새로고침
        })
        .catch(error => {
          console.error('Error:', error);
          alert('채팅방 나가기 중 오류가 발생했습니다: ' + error.message);
        });
      }, 1000); // 1초 대기 후 삭제 요청 실행
    } else {
      console.error('채팅방을 나갈 수 없습니다: 연결되지 않았거나 현재 채팅방이 없습니다.');
      alert('채팅방을 나갈 수 없습니다. 연결 상태를 확인해주세요.');
    }
  }



</script>
</html>