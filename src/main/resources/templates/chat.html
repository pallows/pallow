<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
  <div class="flex">
    <!-- 채팅방 목록 -->
    <div class="w-1/3 bg-white p-4 rounded-l-lg shadow">
      <h2 class="text-xl font-bold mb-4">나의 채팅방</h2>
      <ul id="chatRoomList" class="space-y-2">
        <!-- 채팅방 목록이 여기에 동적으로 추가됩니다 -->
      </ul>
      <button id="createChatRoomBtn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">새 채팅방 만들기</button>
    </div>

    <!-- 채팅 메시지 -->
    <div class="w-2/3 bg-white p-4 rounded-r-lg shadow">
      <h2 id="currentChatRoomName" class="text-xl font-bold mb-4">채팅방을 선택해주세요</h2>
      <div id="chatMessages" class="h-96 overflow-y-auto mb-4">
        <!-- 채팅 메시지가 여기에 동적으로 추가됩니다 -->
      </div>
      <div class="flex">
        <input id="messageInput" type="text" class="flex-grow p-2 border rounded-l" placeholder="메시지를 입력하세요">
        <button id="sendMessageBtn" class="bg-blue-500 text-white px-4 py-2 rounded-r">전송</button>
      </div>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  let currentChatRoomId = null;
  const accessToken = localStorage.getItem('Authorization');
  console.log("엑셋슷톡큰", accessToken)

  if (!accessToken) {
    window.location.href = '/login';
  }

  function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({'Authorization': accessToken}, function (frame) {
      console.log('Connected: ' + frame);
      loadChatRooms();
    });
  }

  function loadChatRooms() {
    fetch('/api/chat/rooms', {
      headers: {
        'Authorization': accessToken
      }
    })
    .then(response => response.json())
    .then(data => {
      const chatRoomList = document.getElementById('chatRoomList');
      chatRoomList.innerHTML = '';
      data.data.forEach(room => {
        const li = document.createElement('li');
        li.textContent = room.name;
        li.className = 'cursor-pointer hover:bg-gray-200 p-2 rounded';
        li.onclick = () => openChatRoom(room.id, room.name);
        chatRoomList.appendChild(li);
      });
    });
  }

  function openChatRoom(roomId, roomName) {
    currentChatRoomId = roomId;
    document.getElementById('currentChatRoomName').textContent = roomName;

    if (stompClient.subscriptions) {
      Object.keys(stompClient.subscriptions).forEach(sub => stompClient.unsubscribe(sub));
    }

    stompClient.subscribe(`/topic/chat/${roomId}`, onMessageReceived);

    loadChatMessages(roomId);
  }

  function loadChatMessages(roomId) {
    fetch(`/api/chat/rooms/${roomId}`, {
      headers: {
        'Authorization': accessToken
      }
    })
    .then(response => response.json())
    .then(data => {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      data.data.messages.forEach(message => {
        appendMessage(message);
      });
    });
  }

  function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    if (message && currentChatRoomId) {
      const chatMessage = {
        chatRoomId: currentChatRoomId,
        content: message
      };
      stompClient.send("/app/chat.sendMessage", {'Authorization': accessToken}, JSON.stringify(chatMessage));
      messageInput.value = '';
    }
  }

  function onMessageReceived(payload) {
    const message = JSON.parse(payload.body);
    appendMessage(message);
  }

  function appendMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = 'mb-2';
    messageElement.innerHTML = `
                <strong>${message.sender}:</strong> ${message.content}
                <small class="text-gray-500">${message.formattedTime}</small>
            `;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function createChatRoom() {
    const roomName = prompt("새 채팅방 이름을 입력하세요:");
    if (roomName) {
      fetch('/api/chat/rooms', {
        method: 'POST',
        headers: {
          'Authorization': accessToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: roomName })
      })
      .then(response => response.json())
      .then(data => {
        alert(`채팅방이 생성되었습니다. 초대 링크: ${window.location.origin}/invite/${data.data.id}`);
        loadChatRooms();
      });
    }
  }

  document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
  document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });
  document.getElementById('createChatRoomBtn').addEventListener('click', createChatRoom);

  connect();
</script>
</body>
</html>