<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="/js/auth.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pallow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 9999;
        }

        #chatBtn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4CAF50;
            border: none;
            outline: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            padding: 0;
        }

        #chatBtn:hover {
            background-color: #45a049;
            transform: scale(1.1);
        }

        #chatBtn svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        .chat-text {
            margin-top: 5px;
            font-size: 14px;
            font-weight: bold;
            color: #4CAF50;
        }

        .relative {
            padding: inherit;
        }

        #dropdown-menu {
            display: none; /* 기본적으로 숨김 상태 */
        }
        #dropdown-menu.show {
            display: block; /* 'show' 클래스를 추가하면 보이도록 설정 */
        }
        #dropdown-menu ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #dropdown-menu li {
            padding: 0;
            margin: 0;
        }
        #dropdown-menu a {
            display: block;
            padding: 8px 16px;
            text-decoration: none;
            color: #333;
        }
        #dropdown-menu a:hover {
            background-color: #f0f0f0;
        }
        /* 드롭다운 메뉴의 최대 높이 및 스크롤 설정 */
        #dropdown-menu {
            max-height: 15rem; /* 최대 높이 설정 */
            overflow-y: auto; /* 세로 스크롤 활성화 */
        }

    </style>
    <link rel="icon"
          href="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FoXBYw%2FbtsIPXrDjTc%2FpLzzFxLchTAtiBSFLAfEX1%2Fimg.png"
          type="image/x-icon">
</head>
<body class="bg-gray-100 text-gray-900">
<header class="flex justify-between items-center p-4 bg-white shadow">
    <div class="flex items-center">
        <a href="/public/main">
            <img src="https://github.com/user-attachments/assets/38c43d3b-dce7-422c-b89a-572308799e96" width="70"
                 height="70" alt="Logo" class="mr-4">
        </a>
        <nav>
            <a th:href="@{/public/main}" class="mr-4">홈</a>
            <a href="/public/profileCollection" class="mr-4">오늘의 동친</a>
            <a href="/public/meetsCollection" class="mr-4">내 주변 모임</a>
            <a href="/public/MyPage" class="mr-4">MyPage</a>
            <a href="/public/userboardCollection" class="mr-4">내 게시물 작성하기</a>
        </nav>
    </div>
    <div class="flex items-center">
        <button id="logoutBtn" class="bg-black text-white px-4 py-2 rounded">로그아웃</button>
    </div>
</header>
<main class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold">모임 생성 하기</h1>
        <button class="bg-black text-white px-4 py-2 rounded" onclick="openCreateMeet()">모임 생성 하기</button>
    </div>

    <!-- 모임 리스트 -->
    <div id="meet-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div th:each="meet : ${meets}" class="bg-white p-4 rounded shadow-md flex items-center space-x-4 meet-card" th:attr="data-likes=${meet.likesCount}">
            <img th:src="${meet.image}" alt="Profile Image" class="w-24 h-24 rounded-full">
            <div>
                <h2 class="text-lg font-bold meet-title" th:text="${meet.title}">모임 제목</h2>
                <p class="text-gray-600" th:text="${meet.content}">모임 설명</p>
                <p class="text-gray-600 mt-2">인원: <span th:text="${meet.memberCount}"></span>/<span th:text="${meet.maxMemberCount}"></span></p>
                <p class="text-gray-600 mt-2">좋아요: <span th:text="${meet.likesCount}"></span></p>
                <div class="mt-4 space-x-2">
                    <a href="javascript:void(0);" class="bg-black text-white px-4 py-2 rounded" th:onclick="'openMeet(' + ${meet.id} + ');'">상세 보기</a>
                </div>
            </div>
        </div>
    </div>

    <div class="relative">
        <input id="search-input" type="text" placeholder="제목 및 작성자 입력" class="w-full p-4 rounded shadow-md">
        <button id="dropdown-button" class="absolute right-4 top-1/2 transform -translate-y-1/2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4H16M8 8H16M8 12H16M8 16H16M8 20H16"/>
            </svg>
        </button>
        <!-- 드롭다운 메뉴 -->
        <div id="dropdown-menu" class="absolute right-4 top-full mt-2 w-40 bg-white border border-gray-200 rounded shadow-lg hidden max-h-60 overflow-y-auto">
            <ul>
                <li><a href="#" data-sort="default" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">기본</a></li>
                <li><a href="#" data-sort="likes" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">좋아요 순</a></li>
            </ul>
        </div>
    </div>

    <div class="chat-container">
        <button id="chatBtn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M2.965 12.695a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6-3.004 6-7 6a8 8 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a11 11 0 0 0 .398-2m-.8 3.108.02-.004c1.83-.363 2.948-.842 3.468-1.105A9 9 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.4 10.4 0 0 1-.524 2.318l-.003.011a11 11 0 0 1-.244.637c-.079.186.074.394.273.362a22 22 0 0 0 .693-.125M8 5.993c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132"/>
            </svg>
        </button>
        <span class="chat-text">채팅하기</span>
    </div>

</main>
<footer class="bg-white shadow-md mt-8">
    <div class="container mx-auto px-4 py-4 flex justify-end">
        <button class="bg-black text-white p-4 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 4H16M8 8H16M8 12H16M8 16H16M8 20H16"/>
            </svg>
        </button>
    </div>
</footer>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        const accessToken = localStorage.getItem('Authorization');
        if (!accessToken) {
            window.location.href = '/login';
            return;
        }

        function fetchWithAuth(url, options = {}) {
            options.headers = {
                ...options.headers,
                'Authorization': accessToken,
                'Content-Type': 'application/json'
            };
            return fetch(url, options);
        }

        document.getElementById('chatBtn').addEventListener('click', async () => {
            try {
                const response = await fetchWithAuth('/chat.html');
                if (response.ok) {
                    window.location.href = '/chat.html';
                } else {
                    console.error('Failed to load chat.html');
                }
            } catch (error) {
                console.error('Error loading chat.html:', error);
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const meetCards = document.querySelectorAll('.meet-card');

        searchInput.addEventListener('input', function() {
            const query = searchInput.value.toLowerCase();
            meetCards.forEach(function(card) {
                const title = card.querySelector('.meet-title').textContent.toLowerCase();
                if (title.includes(query)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const dropdownButton = document.getElementById('dropdown-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const meetContainer = document.getElementById('meet-container');
        const meetCards = Array.from(document.querySelectorAll('.meet-card'));

        if (!meetContainer) {
            console.error('Error: meetContainer is null. Please check the ID.');
            return;
        }

        dropdownButton.addEventListener('click', function() {
            dropdownMenu.classList.toggle('show');
        });

        dropdownMenu.addEventListener('click', function(event) {
            if (event.target.tagName === 'A') {
                const sortType = event.target.getAttribute('data-sort');
                console.log('Selected sort type:', sortType);

                if (sortType === 'likes') {
                    // 좋아요 순으로 정렬
                    meetCards.sort(function(a, b) {
                        const likesA = parseInt(a.getAttribute('data-likes'));
                        const likesB = parseInt(b.getAttribute('data-likes'));
                        return likesB - likesA; // 좋아요 수에 따른 내림차순 정렬
                    });
                } else {
                    // 기본 정렬 (이름순 예시)
                    meetCards.sort(function(a, b) {
                        const titleA = a.querySelector('.meet-title').textContent.toLowerCase();
                        const titleB = b.querySelector('.meet-title').textContent.toLowerCase();
                        return titleA.localeCompare(titleB); // 이름순 정렬
                    });
                }

                // 정렬된 요소를 DOM에 다시 추가
                meetCards.forEach(function(card) {
                    meetContainer.appendChild(card);
                });

                dropdownMenu.classList.remove('show');
            }
        });

        // 드롭다운 외부 클릭 시 메뉴 닫기
        document.addEventListener('click', function(event) {
            if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('show');
            }
        });
    });

    async function openCreateMeet() {
        window.location.href = '/public/kakaoMap'; // 모임 생성하기로 이동
    }

    async function openMeet(meetId) {
        const width = 800;
        const height = 1000;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(`/public/meets/${meetId}`, '_blank', `width=${width},height=${height},top=${top},left=${left}`);// 모임 상세 페이지로 이동
    }
</script>
</body>
</html>